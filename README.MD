üìö Bibliotrack API
Un sistema de gesti√≥n de biblioteca robusto y completo construido con Node.js + Express y respaldado por una base de datos MySQL. El sistema est√° dise√±ado para manejar todas las operaciones cr√≠ticas de una biblioteca, desde la catalogaci√≥n de materiales hasta la gesti√≥n de multas.

‚ú® Caracter√≠sticas Principales
üì¶ Gesti√≥n de Cat√°logo Extensa: Soporta m√∫ltiples tipos de materiales, incluyendo libros, revistas, tesis, CD/DVD, dispositivos tecnol√≥gicos y juegos educativos.

‚úçÔ∏è M√∫ltiples Autores: Maneja correctamente la relaci√≥n N:M entre materiales y autores.

üìã Control de Inventario: Realiza un seguimiento de cada ejemplar f√≠sico, su ubicaci√≥n, y estado (disponible, prestado, en reparaci√≥n, etc.).

üë• Administraci√≥n de Usuarios: Sistema de roles (admin, estudiante, docente) con permisos definidos.

‚öôÔ∏è L√≥gica de Negocio Transaccional: Incluye un flujo completo para reservas, pr√©stamos, devoluciones y c√°lculo autom√°tico de multas por retraso.

üõ°Ô∏è Auditor√≠a y Seguridad: Registra todas las acciones importantes en un historial para seguimiento y control.

üöÄ L√≥gica de Base de Datos Optimizada: Utiliza Stored Procedures, Triggers y Vistas para encapsular la l√≥gica de negocio, mejorar el rendimiento y garantizar la integridad de los datos.

üõ†Ô∏è Stack Tecnol√≥gico
Backend: Node.js, Express.js

Base de Datos: MySQL

Frontend (potencial): Preparado para ser consumido por cualquier framework como Angular, React o Vue.

üöÄ C√≥mo Empezar
Sigue estos pasos para configurar y ejecutar el proyecto en tu entorno local.

Prerrequisitos
Node.js (v18 o superior)

NPM

Una instancia de MySQL Server en ejecuci√≥n.

Instalaci√≥n y Ejecuci√≥n
Clona el repositorio:

Bash

git clone https://github.com/tu-usuario/bibliotrack-api.git
cd bibliotrack-api
Instala las dependencias:

Bash

npm install
Configura las variables de entorno:
Crea un archivo .env en la ra√≠z del proyecto y a√±ade la configuraci√≥n de tu base de datos.

Ini, TOML

# Puerto de la aplicaci√≥n
PORT=3000

# Configuraci√≥n de la Base de Datos MySQL
DB_HOST=localhost
DB_USER=root
DB_PASS=TU_PASSWORD_SECRETO
DB_NAME=bibliotrack
DB_PORT=3306
Ejecuta el servidor en modo de desarrollo:
El servidor se reiniciar√° autom√°ticamente con cada cambio.

Bash

npm run dev
El API estar√° disponible en http://localhost:3000.

üóÑÔ∏è Dise√±o de la Base de Datos (bibliotrack)
La base de datos est√° normalizada y estructurada para ser eficiente y escalable.

Tablas Principales
Tabla	Descripci√≥n
categoria	Cat√°logo de categor√≠as de materiales (ej. "Ciencia Ficci√≥n", "Investigaci√≥n").
tipo_usuario	Roles y permisos de los usuarios en formato JSON.
material_bibliografico	Registro base que contiene la informaci√≥n com√∫n de todos los materiales.
Subtablas de material	libro, revista, tesis, cd, dvd, dispositivo_tecnologico, juego_educativo. Heredan de material_bibliografico.
autor	Cat√°logo de autores registrados en el sistema.
material_autor	Tabla pivote para la relaci√≥n N:M entre material_bibliografico y autor.
ejemplar_fisico	Cada copia f√≠sica de un material, con su ubicaci√≥n, c√≥digo de inventario y estado.
usuario	Datos de los usuarios registrados, su rol y el estado de su cuenta (activo, bloqueado).
reserva	Reservas de ejemplares con fecha de expiraci√≥n y estado (activa, vencida, cancelada, atendida).
prestamo	Registro de pr√©stamos de ejemplares, con fechas de pr√©stamo, devoluci√≥n esperada y estado.
multa	Multas generadas autom√°ticamente y asociadas a pr√©stamos devueltos con retraso.
historial_accion	Tabla de auditor√≠a que registra las acciones relevantes realizadas por los usuarios.

Exportar a Hojas de c√°lculo
‚öôÔ∏è Stored Procedures (L√≥gica de Negocio)
sp_registrar_prestamo(p_id_usuario, p_id_ejemplar, p_fecha_esperada)
Encapsula la l√≥gica para registrar un nuevo pr√©stamo.

Validaciones:

Verifica que el usuario est√© activo.

Comprueba que el usuario no tenga multas pendientes de pago.

Confirma que el ejemplar est√© disponible.

Impide el pr√©stamo si el ejemplar est√° reservado por otro usuario.

Acciones:

Inserta el nuevo registro en la tabla prestamo.

Actualiza el estado del ejemplar_fisico a prestado.

Si el mismo usuario ten√≠a el ejemplar reservado, actualiza el estado de la reserva a atendida.

Registra la transacci√≥n en historial_accion.

SQL

CALL sp_registrar_prestamo(2, 5, DATE_ADD(NOW(), INTERVAL 3 DAY));
sp_registrar_devolucion(p_id_prestamo, p_fecha_dev)
Gestiona la devoluci√≥n de un ejemplar.

Acciones:

Actualiza la fecha_dev y el estado_dev del pr√©stamo.

Cambia el estado del ejemplar_fisico de vuelta a disponible.

Genera una multa si p_fecha_dev es posterior a la fecha_esperada (tasa de 0.50 por d√≠a de atraso).

Registra la devoluci√≥n en historial_accion.

SQL

CALL sp_registrar_devolucion(3, NOW());
‚õî Triggers (Reglas Autom√°ticas)
trg_reserva_limit
Se ejecuta BEFORE INSERT en la tabla reserva.

Restricci√≥n: Impide que un usuario tenga m√°s de 3 reservas activas simult√°neamente.

SQL

-- L√≥gica del Trigger
IF (SELECT COUNT(*) FROM reserva WHERE id_usuario=NEW.id_usuario AND estado_reserva='activa') >= 3 THEN
  SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT='L√≠mite de 3 reservas activas alcanzado.';
END IF;
trg_reserva_vencida
Se ejecuta BEFORE UPDATE en la tabla reserva.

L√≥gica: Si la fecha actual ha superado la fecha_expiracion y la reserva sigue activa, la cambia autom√°ticamente a vencida.

üëì Vistas (Reportes R√°pidos)
vw_disponibilidad: Un listado completo de todos los materiales y sus ejemplares, mostrando su estado actual (disponible, prestado, reservado, etc.).

vw_multas_usuario: Un resumen de todas las multas (pendientes y pagadas) agrupadas por usuario.

üåê API Endpoints
A continuaci√≥n se detallan los endpoints principales del API.

Healthcheck
GET / - Verifica que el API est√© funcionando correctamente.

JSON

{
  "ok": true,
  "api": "Bibliotrack API",
  "version": "1.0.0"
}
Materiales
GET /api/materiales - Lista todos los materiales.

GET /api/materiales?q=texto - Busca materiales por t√≠tulo o autor.

GET /api/materiales/:id - Obtiene los detalles de un material espec√≠fico.

GET /api/materiales/:id/ejemplares - Lista todos los ejemplares f√≠sicos de un material.

Reservas
POST /api/reservas - Crea una nueva reserva para un usuario y un ejemplar.

JSON

{
  "id_usuario": 1,
  "id_ejemplar": 1
}
PATCH /api/reservas/:id/cancelar - Cancela una reserva activa.

GET /api/reservas/usuario/:id - Lista todas las reservas de un usuario.

Pr√©stamos y Devoluciones
POST /api/prestamos - Registra un nuevo pr√©stamo (ejecuta sp_registrar_prestamo).

JSON

{
  "id_usuario": 2,
  "id_ejemplar": 5,
  "fecha_esperada": "2025-08-15 12:00:00"
}
POST /api/devoluciones - Registra una devoluci√≥n (ejecuta sp_registrar_devolucion).

JSON

{
  "id_prestamo": 3,
  "fecha_dev": "2025-08-16 10:00:00"
}
GET /api/prestamos/usuario/:id - Obtiene el historial de pr√©stamos de un usuario.

Reportes
GET /api/reportes/disponibilidad - Devuelve los datos de la vista vw_disponibilidad.

GET /api/reportes/multas - Devuelve los datos de la vista vw_multas_usuario.

üìå Ejemplo de Flujo de Prueba
Listar todos los materiales para ver qu√© hay disponible:
GET /api/materiales

Ver los ejemplares de un material de inter√©s (ej: con ID 1):
GET /api/materiales/1/ejemplares

Crear una reserva para el usuario 1 sobre el ejemplar 1:
POST /api/reservas con {"id_usuario": 1, "id_ejemplar": 1}

Realizar un pr√©stamo directo para el usuario 2 con el ejemplar 5, con 3 d√≠as de plazo:
POST /api/prestamos con {"id_usuario": 2, "id_ejemplar": 5, "fecha_esperada": "2025-08-18 10:00:00"}

Consultar los pr√©stamos activos del usuario 2:
GET /api/prestamos/usuario/2

Registrar la devoluci√≥n del pr√©stamo anterior:
POST /api/devoluciones con el id_prestamo obtenido en el paso 5.

Consultar los reportes para ver el estado general:
GET /api/reportes/disponibilidad
GET /api/reportes/multas